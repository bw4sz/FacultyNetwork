---
title: "Academic Betadiversity and Future of Biology Research"
author: "Ben Weinstein"
date: "Thursday, April 23, 2015"
output: html_document
---


```{r,warning=FALSE,message=FALSE}
#Scopus Database Query By Journal Article
library(XML)
library(plyr)
library(dplyr)
library(ggplot2)
library(reshape2)
library(httr)
library(stringr)
library(chron)
library(vegan)
library(knitr)
library(bipartite)
library(sna)
library(igraph)
library(knitr)
```


```{r,}
#source functions
source("Funtions.R")

#set knitr options
opts_chunk$set(echo=T,cache=T,fig.align='center',fig.height=6,fig.width=7,)
```

Read in data. Processed from ByJournal.R
```{r}
tocompare<-read.csv("C:/Users/Ben/Dropbox/FacultyNetwork/ParsedData.csv")

#what does it look like:
head(tocompare)
```

Basic data cleaning. We only want records from active authors. Atleast 5 publications in the entire record.

```{r}
#filter authors
#distribution of publication
keep<-names(which(table(tocompare$Author)>4))
tocompare<-droplevels(tocompare[tocompare$Author %in% keep,])

#remove duplicates.
tocompare<-tocompare[!duplicated(tocompare),]

#in case the column names in there 
tocompare<-droplevels(tocompare[!tocompare$Journal %in% "DOI",])
```


Basic descriptive stats on results
```{r}
#How many journals
paste("Number of Journals:",length(unique(tocompare$Journal)))

#How many authors
paste("Number of Authors:",length(unique(tocompare$Author)))

#How many papers
paste("Number of Papers:",length(unique(tocompare$DOI)))

```

How many papers from each discipline over time?
```{r}
class_year<-group_by(tocompare,Class,Year) %>% summarize(Papers=length(unique(DOI)))
ggplot(class_year,aes(x=as.factor(Year),y=Papers,col=Class,group=Class)) + geom_line() + theme_bw() + facet_wrap(~Class,scale="free_y",ncol=4) + labs(x="Year")
```

Create matrix of authors in each class - analagous to the site by species matrix used in ecology

```{r}
siteXspp<-as.data.frame.array(table(tocompare$Author,tocompare$Class))
dim(siteXspp)
```

#Dissimalarity among classes

Use the abundance of papers by each author to calculate niche overlap (dist=1-Horn's) between classes. 

Low overlap=0
High overlap=1


```{r}
#Compare disciplines
topics<-1-as.matrix(vegdist(t(siteXspp),"horn"))
```

Visualize interactions.

  * Stronger interactions are more red.
  * Weaker interactions are blue.
  * Stronger connections are thicker
  * Weaker connections are thinner
  * More central members (greater number of partners) are in larger text
  * Less central members (fewer number of partners) are in smaller text
  
```{r}
g<-graph.adjacency(topics,"undirected",weighted=TRUE)

g<-simplify(g)

# set labels and degrees of vertices
V(g)$label <- V(g)$name
V(g)$degree <- degree(g)
layout1 <- layout.fruchterman.reingold(g)


V(g)$label.color <- rgb(0, 0, .2, .8)
V(g)$frame.color <- NA
egam=E(g)$weight/max(E(g)$weight)
E(g)$color<-rgb(0,1,0,alpha=E(g)$weight/max(E(g)$weight),maxColorValue=1)

ramp <- colorRamp(c("blue","red"),alpha=T)

E(g)$color = apply(ramp(E(g)$weight), 1, function(x) rgb(x[1]/255,x[2]/255,x[3]/255,alpha=T) )

# plot the graph in layout1
layout1<- layout.fruchterman.reingold(g)

#If you need to delete
g.copy <- delete.edges(g, which(E(g)$weight<.05))
#width
width<-(E(g.copy)$weight/max(E(g.copy)$weight))*8

#label sizes
V(g.copy)$label.cex <- V(g.copy)$degree / max(V(g.copy)$degree)*1+.2
plot(g.copy,vertex.size=6,edge.width=width)
```

View as a dendrogram

```{r}
wt <- walktrap.community(g, modularity=TRUE)
dend <- as.dendrogram(wt, use.modularity=TRUE)
plot(as.hclust(dend))
```

#Calculate network statistics

We are interested in the centrality, modularity and compartamentalization of the biological sciences

  * Betweenness - number of shortest path that includes node
  * Degree - number of connections for each node
  * Closeness - relative distance to all actors
  * Coreness - 
```{r}
between_class<-betweenness(g.copy)
degree_class<-degree(g.copy)
closeness_class<-closeness(g.copy)
corness_class<-graph.coreness(g.copy)
eigenV<-evcent(g.copy)$vector
vdat<-data.frame(Class=names(between_class),Between=between_class,Degree=degree_class,Closeness=closeness_class,Coreness=corness_class,Eigen=eigenV)
```

Top actors for each statistic
```{r}
mdat<-melt(vdat)

topactors<-group_by(mdat,Class,variable) %>% arrange(value) %>% top_n(5)
bottomactors<-group_by(mdat,Class,variable) %>% arrange(desc(value)) %>% top_n(5)

```

```{r}
ggplot(topactors,aes(x=Class,y=value)) + geom_bar(stat="identity") + facet_wrap(~variable,scale="free",ncol=1)
```

Relationship between eigen =vector and betweenness
```{r}
ggplot(aes=)
#Network analysis for journals

```{r}
#Network analysis of journals as undirected graph
siteXspp_j<-as.data.frame.array(table(tocompare$Author,tocompare$Journal))

#Compare disciplines
topics<-1-as.matrix(vegdist(t(siteXspp_j),"horn"))
g<-graph.adjacency(topics,"undirected",weighted=TRUE)
g<-simplify(g)

# set labels and degrees of vertices
V(g)$label <- V(g)$name
V(g)$degree <- degree(g)
layout1 <- layout.fruchterman.reingold(g)

#get h5 index for each journal
j<-V(g)$name
ramp <- colorRamp(c("white","black"),alpha=T)
ind<-filter(tocompare,Journal %in% j) %>% distinct(h5.index)
vertex_index<-sapply(j,function(x){ind[ind$Journal==x,"h5.index"]})

V(g)$color<-apply(ramp(vertex_index/max(vertex_index)), 1, function(x) rgb(x[1]/255,x[2]/255,x[3]/255,alpha=T) )

V(g)$label.color <- rgb(0, 0, .2, .8)
V(g)$frame.color <- NA

egam=E(g)$weight/max(E(g)$weight)
ramp <- colorRamp(c("blue","red"),alpha=T)
E(g)$color = apply(ramp(E(g)$weight), 1, function(x) rgb(x[1]/255,x[2]/255,x[3]/255,alpha=T) )

# plot the graph in layout1
layout1<- layout.fruchterman.reingold(g)
#plot.igraph(g,edge.width=E(g)$weight/max(E(g)$weight)*2,layout=layout1)

#If you need to delete
g.copy <- delete.edges(g, which(E(g)$weight <.05))
V(g.copy)$label.cex <- V(g.copy)$degree / max(V(g.copy)$degree)+ .1
plot(g.copy)
```

Just view one subsection - Ecology

```{r}
#Centrality of Journals
betweenJ<-sort(betweenness(g.copy))

wt <- walktrap.community(g, modularity=TRUE)
dend <- as.dendrogram(wt, use.modularity=TRUE)
plot(as.hclust(dend))

###Connectance through time

yearcompare<-split(tocompare,tocompare$Year)

yeardat<-lapply(yearcompare,function(x){
  siteXspp<-as.data.frame.array(table(x$Author,x$Class))
  
  #Compare disciplines
  topics<-1-as.matrix(vegdist(t(siteXspp),"horn"))
  diag(topics)<-NA
  return(topics)
})

yeardat<-melt(yeardat)

colnames(yeardat)<-c("To","From","Niche.Overlap","Year")

#remove very weak connections
#work from an example data
#make into characters
yeardat$To<-as.character(yeardat$To)
yeardat$From<-as.character(yeardat$From)

exdat<-group_by(yeardat,To,From) %>% filter(To=="Ecology",Niche.Overlap>0.02)
exdat$Combo<-paste(exdat$To,exdat$From,sep="-")
ggplot(exdat,aes(x=Year,y=Niche.Overlap,col=Combo)) + geom_point() + geom_smooth(aes(group=Combo)) + facet_wrap(~Combo,scales="free")

#trend estimation
#first pass just fit a linear line and determine if its possitive or negative
yeardat$combo<-paste(sort(c(yeardat$To,yeardat$From)))
lm(data=yeardat,(Niche.Overlap~Year:paste(To,From)))

#make time series
#estimate trend
#if trend is changing is positive label

###D3 Visualizations

###Which groups are most specailized?


save.image("Analysis.RData")
